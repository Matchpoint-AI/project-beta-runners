name: Manual Operations

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan-all
          - apply-state-1
          - apply-state-2
          - apply-state-3
          - destroy-all
      confirm_destroy:
        description: 'Type DESTROY to confirm destruction'
        required: false
        type: string

env:
  TERRAGRUNT_VERSION: '0.54.0'
  TERRAFORM_VERSION: '1.5.7'

jobs:
  manual:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Plan All
        if: inputs.action == 'plan-all'
        working-directory: infrastructure/live/prod
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
          RACKSPACE_SPOT_TOKEN: ${{ secrets.RACKSPACE_SPOT_API_TOKEN }}
          ARC_GITHUB_APP_ID: ${{ secrets.ARC_GITHUB_APP_ID }}
          ARC_GITHUB_APP_INSTALLATION_ID: ${{ secrets.ARC_GITHUB_APP_INSTALLATION_ID }}
          ARC_GITHUB_APP_PRIVATE_KEY: ${{ secrets.ARC_GITHUB_APP_PRIVATE_KEY }}
        run: terragrunt run-all plan

      - name: Apply State 1
        if: inputs.action == 'apply-state-1'
        working-directory: infrastructure/live/prod/1-cloudspace
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
          RACKSPACE_SPOT_TOKEN: ${{ secrets.RACKSPACE_SPOT_API_TOKEN }}
        run: terragrunt apply -auto-approve

      - name: Apply State 2
        if: inputs.action == 'apply-state-2'
        working-directory: infrastructure/live/prod/2-cluster-base
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
          RACKSPACE_SPOT_TOKEN: ${{ secrets.RACKSPACE_SPOT_API_TOKEN }}
        run: terragrunt apply -auto-approve

      - name: Apply State 3
        if: inputs.action == 'apply-state-3'
        working-directory: infrastructure/live/prod/3-argocd-apps
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
          RACKSPACE_SPOT_TOKEN: ${{ secrets.RACKSPACE_SPOT_API_TOKEN }}
          ARC_GITHUB_APP_ID: ${{ secrets.ARC_GITHUB_APP_ID }}
          ARC_GITHUB_APP_INSTALLATION_ID: ${{ secrets.ARC_GITHUB_APP_INSTALLATION_ID }}
          ARC_GITHUB_APP_PRIVATE_KEY: ${{ secrets.ARC_GITHUB_APP_PRIVATE_KEY }}
        run: terragrunt apply -auto-approve

      - name: Destroy All
        if: inputs.action == 'destroy-all' && inputs.confirm_destroy == 'DESTROY'
        working-directory: infrastructure/live/prod
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
          RACKSPACE_SPOT_TOKEN: ${{ secrets.RACKSPACE_SPOT_API_TOKEN }}
          ARC_GITHUB_APP_ID: ${{ secrets.ARC_GITHUB_APP_ID }}
          ARC_GITHUB_APP_INSTALLATION_ID: ${{ secrets.ARC_GITHUB_APP_INSTALLATION_ID }}
          ARC_GITHUB_APP_PRIVATE_KEY: ${{ secrets.ARC_GITHUB_APP_PRIVATE_KEY }}
        run: terragrunt run-all destroy -auto-approve

      - name: Destroy Rejected
        if: inputs.action == 'destroy-all' && inputs.confirm_destroy != 'DESTROY'
        run: |
          echo "‚ùå Destroy rejected - confirmation text did not match"
          echo "Expected: DESTROY"
          echo "Got: ${{ inputs.confirm_destroy }}"
          exit 1
