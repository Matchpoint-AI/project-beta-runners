# Cloudspace Status Workflow
#
# Provides visibility into Rackspace Spot cloudspace provisioning status.
# Use this to debug stuck deployments or check cluster health.
#
# spotctl docs: https://github.com/rackspace-spot/spotctl

name: Cloudspace Status

on:
  workflow_dispatch:
    inputs:
      cloudspace_name:
        description: 'Cloudspace name to check'
        required: true
        default: 'mp-runners-v3'
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - status
          - nodepools
          - kubeconfig-check
          - full-diagnostics
        default: 'status'

env:
  SPOTCTL_VERSION: '0.1.1'

jobs:
  status:
    name: Check Cloudspace Status
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Install spotctl
        run: |
          echo "Installing spotctl v${SPOTCTL_VERSION}..."
          curl -sL "https://github.com/rackspace-spot/spotctl/releases/download/v${SPOTCTL_VERSION}/spotctl-linux-amd64" -o spotctl
          chmod +x spotctl
          sudo mv spotctl /usr/local/bin/
          spotctl --version

      - name: Configure spotctl
        env:
          RACKSPACE_SPOT_TOKEN: ${{ secrets.RACKSPACE_SPOT_API_TOKEN }}
          RACKSPACE_ORG: ${{ secrets.RACKSPACE_ORG }}
        run: |
          # Verify secrets are set
          if [ -z "${RACKSPACE_SPOT_TOKEN}" ]; then
            echo "::error::RACKSPACE_SPOT_API_TOKEN secret not set"
            exit 1
          fi
          if [ -z "${RACKSPACE_ORG}" ]; then
            echo "::error::RACKSPACE_ORG secret not set"
            exit 1
          fi
          
          # Create config file at ~/.spot_config in YAML format
          cat > ~/.spot_config << EOF
          org: "${RACKSPACE_ORG}"
          refreshToken: "${RACKSPACE_SPOT_TOKEN}"
          region: "us-central-ord-1"
          EOF
          
          chmod 600 ~/.spot_config
          echo "✅ spotctl configured for org: ${RACKSPACE_ORG}"

      - name: Get cloudspace status
        if: inputs.action == 'status' || inputs.action == 'full-diagnostics'
        env:
          CLOUDSPACE: ${{ inputs.cloudspace_name }}
        run: |
          echo "==========================================="
          echo "  Cloudspace: $CLOUDSPACE"
          echo "==========================================="
          echo ""
          
          # Get detailed status
          if spotctl cloudspaces get "$CLOUDSPACE" --output json > /tmp/status.json 2>&1; then
            echo "Status: $(jq -r '.status // "Unknown"' /tmp/status.json)"
            echo "Region: $(jq -r '.region // "Unknown"' /tmp/status.json)"
            echo "Created: $(jq -r '.created_at // "Unknown"' /tmp/status.json)"
            echo ""
            echo "Full response:"
            jq '.' /tmp/status.json
          else
            echo "::warning::Cloudspace $CLOUDSPACE not found or error fetching status"
            cat /tmp/status.json 2>/dev/null || echo "No response"
          fi

      - name: List node pools
        if: inputs.action == 'nodepools' || inputs.action == 'full-diagnostics'
        env:
          CLOUDSPACE: ${{ inputs.cloudspace_name }}
        run: |
          echo "==========================================="
          echo "  Node Pools for: $CLOUDSPACE"
          echo "==========================================="
          echo ""
          
          echo "=== Spot Node Pools ==="
          spotctl nodepools spot list --cloudspace "$CLOUDSPACE" --output table 2>/dev/null || echo "No spot pools or error"
          
          echo ""
          echo "=== On-Demand Node Pools ==="
          spotctl nodepools ondemand list --cloudspace "$CLOUDSPACE" --output table 2>/dev/null || echo "No on-demand pools or error"

      - name: Check kubeconfig availability
        if: inputs.action == 'kubeconfig-check' || inputs.action == 'full-diagnostics'
        env:
          CLOUDSPACE: ${{ inputs.cloudspace_name }}
        run: |
          echo "==========================================="
          echo "  Kubeconfig Check: $CLOUDSPACE"
          echo "==========================================="
          echo ""
          
          if spotctl cloudspaces get-config "$CLOUDSPACE" --file /tmp/kubeconfig 2>/dev/null; then
            echo "✅ Kubeconfig is available!"
            echo ""
            echo "Cluster info:"
            KUBECONFIG=/tmp/kubeconfig kubectl cluster-info 2>/dev/null || echo "kubectl not available for detailed check"
          else
            echo "❌ Kubeconfig not yet available"
            echo "   This usually means the cluster is still provisioning"
          fi

      - name: List all cloudspaces
        if: inputs.action == 'full-diagnostics'
        run: |
          echo "==========================================="
          echo "  All Cloudspaces in Organization"
          echo "==========================================="
          echo ""
          spotctl cloudspaces list --output table

      - name: Summary
        env:
          CLOUDSPACE: ${{ inputs.cloudspace_name }}
          RACKSPACE_ORG: ${{ secrets.RACKSPACE_ORG }}
        run: |
          echo ""
          echo "==========================================="
          echo "  Troubleshooting Commands"
          echo "==========================================="
          echo ""
          echo "Run these locally with spotctl:"
          echo "  spotctl cloudspaces get $CLOUDSPACE --output json"
          echo "  spotctl cloudspaces get-config $CLOUDSPACE --file ~/.kube/config-$CLOUDSPACE"
          echo "  spotctl nodepools spot list --cloudspace $CLOUDSPACE"
          echo "  spotctl cloudspaces delete --name $CLOUDSPACE  # If stuck, delete and retry"
